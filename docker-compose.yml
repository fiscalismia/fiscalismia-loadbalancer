#####################################################################################
# Fiscalismia-Loadbalancer HAProxy as central HTTPS Ingress for hcloud infrastructure
#####################################################################################

services:
  haproxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: haproxy
    image: fiscalismia/haproxy-loadbalancer:latest

    restart: unless-stopped

    # Network mode: host to access private network interfaces
    # In production on Hetzner VPS, this allows HAProxy to bind to:
    # - Public IP for incoming HTTPS traffic
    # - Private IPs (172.20.1.3 and 172.24.1.3) for backend routing
    network_mode: host

    environment:
      - TZ=Europe/Berlin
    env_file:
      - .env

    volumes:
      # Mount config for hot-reload (development)
      # The ':z' flag is required on SELinux-enabled systems (like Fedora/CentOS)
      # to relabel the host directory. This allows the container to access the
      # mounted volume by applying a shared SELinux label.
      - ./haproxy.cfg:/usr/local/etc/haproxy.cfg:ro,z

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:8404/stats"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Read-only root filesystem (best practice)
    read_only: true
    tmpfs:
      - /tmp
      - /run

    # Capabilities (minimal required permissions)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required to bind to ports < 1024