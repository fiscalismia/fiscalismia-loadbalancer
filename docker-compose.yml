#####################################################################################
# Fiscalismia-Loadbalancer HAProxy as central HTTPS Ingress for hcloud infrastructure
#####################################################################################

services:
  haproxy:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: fiscalismia-loadbalancer
    image: fiscalismia/haproxy-loadbalancer:latest

    # Restart policy for production
    restart: unless-stopped

    # Network mode: host to access private network interfaces
    # In production on Hetzner VPS, this allows HAProxy to bind to:
    # - Public IP for incoming traffic
    # - Private IPs (172.20.1.3 and 172.24.1.3) for backend routing
    network_mode: host

    # Environment variables
    environment:
      - TZ=Europe/Berlin

    # Volume mounts for configuration
    volumes:
      # Mount config for hot-reload (development)
      - ./haproxy.cfg:/usr/local/etc/haproxy/haproxy.cfg:ro

    # Logging configuration
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    # Health check
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8404/stats"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s

    # Read-only root filesystem (best practice)
    read_only: true
    tmpfs:
      - /tmp
      - /run

    # Capabilities (minimal required permissions)
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE  # Required to bind to ports < 1024