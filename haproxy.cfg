###########################################################################################
# Fiscalismia-Loadbalancer HAProxy as central Layer 4 TCP Ingress for hcloud infrastructure
#
# Host-Based-Routing in Private Network:
#   - fiscalismia.com                    -> Frontend      (172.24.0.3)
#   - backend.fiscalismia.com            -> Backend       (172.24.0.4)
#   - fastapi.fiscalismia.com            -> Fastapi       (172.24.0.4)
#   - demo.fiscalismia.com               -> Demo Frontend (172.20.0.2)
#   - backend.demo.fiscalismia.com       -> Demo Backend  (172.20.0.2)
#   - fastapi.demo.fiscalismia.com       -> Demo Fastapi  (172.20.0.2)
#   - monitoring.fiscalismia.com         -> Monitoring    (172.24.0.2)

# Uses Server Name Indication as part of the TLS protocol for identifying dns routes
# Uses PROXY Protocol v2 prepending headers to TCP packets for source address preservation
# ┌──────────────────────────────────────────────────────────────────────────────┐
# │                         TCP Connection                                       │
# ├───────────────────────┬──────────────────────────────────────────────────────┤
# │   PROXY Protocol v2   │              Original TLS Stream                     │
# │       Header          │                                                      │
# │    (first bytes)      │  TLS ClientHello │ TLS ServerHello │ Encrypted HTTP  │
# └───────────────────────┴──────────────────────────────────────────────────────┘
#          │                                          │
#          ▼                                          ▼
# ┌─────────────────────────────┐          ┌─────────────────────────┐
# │ Binary header containing:   │          │ Untouched TLS stream    │
# │ - Signature (12 bytes)      │          │ passed to TLS library   │
# │ - Version/Command           │          │ for decryption          │
# │ - Protocol (TCP4/TCP6)      │          └─────────────────────────┘
# │ - Address length            │
# │ - Source IP: 203.0.113.42   │  ◄── Client IP preservation
# │ - Dest IP: 1.2.3.4          │
# │ - Source Port: 54321        │
# │ - Dest Port: 443            │
# └─────────────────────────────┘
###########################################################################################

# Process-wide security and performance tunings affecting HAProxy at a low-level
global
    # Maximum simultaneous connections to limit memory consumption
    maxconn 4096


    # Non-root service user as security best-practice
    user haproxy
    group haproxy

    # Run as daemon: Forks into background after startup (production mode)
    # Disable this for debugging or when running in Docker foreground
    # TODO enable in prod
    # daemon

defaults

    # Logging: Send logs to stdout in raw format at info level, exposing docker container logs in live tail
    log     stdout format raw local0 debug
    # Layer 4 TLS Passthrough of binary TCP packets
    mode    tcp
    # Enable TCP log format (required for log-profile to function, see haproxy/haproxy#2891)
    option tcplog

    ##### CONNECTION SETTINGS #####
    # Number of connection retry attempts before giving up
    retries 3
    # Time to wait for connections to the backend servers to establish
    timeout connect 5s
    # Inactivity time on client side before closing connection
    timeout client  20s
    # Inactivity time on server side before closing connection
    timeout server  20s
    # TCP specific long-lived sessions
    timeout tunnel 3m

    ##### DEFAULT BACKEND SERVER CONFIG #####
    # - check: Enable health checks
    # - inter: Check interval (every 10 seconds)
    # - fall:  Mark server as down after 3 failed checks
    # - rise:  Mark server as up after 2 successful checks
    default-server check inter 10s fall 3 rise 2

# HAProxy 3.1+ feature, emitting multiple log lines per tcp connection
# For formats, see https://docs.haproxy.org/3.2/configuration.html#8.2 https://www.haproxy.com/blog/haproxy-log-customization
log-profile tcp_lifecycle

    log-tag haproxy-tcp
    # initial tcp connection ingress to LB
    on accept       format "%ci:%cp [%t] %ft ACCEPT  ac=%ac fc=%fc"
    # tcp connection to backend established
    on connect      format "%ci:%cp [%t] %ft %b/%s CONNECT Tw=%Tw Tc=%Tc Tt=%Tt B=%B ts=%ts ac=%ac fc=%fc bc=%bc sc=%sc sq=%sq bq=%bq"
    # tcp session fully terminated
    on close        format "%ci:%cp [%t] %ft %b/%s CLOSE Tw=%Tw Tc=%Tc Tt=%Tt B=%B ts=%ts ac=%ac fc=%fc bc=%bc sc=%sc sq=%sq bq=%bq"
    # any tcp errors - emmited automatically, does not require frontend subscription
    on error        format "%ci:%cp [%t] %ft %b/%s ERROR Tw=%Tw Tc=%Tc Tt=%Tt B=%B ts=%ts ac=%ac fc=%fc bc=%bc sc=%sc"
    # connections that survived filtering like rate-limit and sni rules
    on tcp-req-cont format "%ci:%cp [%t] %ft TCP-REQ-CONT => Tcp Connection survived rate-limit and sni-rule filtering"

#######################################################################
# FRONTEND - HTTP (Port 80) Redirect to HTTPS (443)
#######################################################################
frontend http_ingress
    bind *:80
    mode http

    # Override inherited TCP log with HTTP log format for richer detail.
    # Shows method, URI, status code — useful for identifying what scanners probe.
    option httplog

    # Allowed new connections per second
    rate-limit sessions 128

    # Redirect all HTTP to HTTPS
    http-request redirect scheme https code 301

#######################################################################
# FRONTEND - HTTPS (Port 443) TLS Passthrough with SNI Routing
#######################################################################
frontend https_ingress
    bind *:443
    mode tcp

    # Wait for TLS ClientHello to read SNI
    tcp-request inspect-delay 5s

    ##### LOGGING WITH LOG PROFILE #####
    # "no log" clears the inherited "log" directive from the defaults section avoiding duplicates.
    no log
    log-steps accept,connect,close,tcp-req-cont
    # "format raw" strips syslog envelope for clean podman/docker stdout output.
    log stdout format raw profile tcp_lifecycle local0 debug

    ##### RATE LIMITING #####
    # Tracks connections per ip address in a sliding window
    # If concurrent connections over the conn_rate window are exceeded,
    # then we silently drop the tcp connection leading to timeouts for the attacker.
    stick-table type ip size 500k expire 60s store conn_rate(3s)
    tcp-request connection track-sc0 src
    tcp-request content silent-drop if { src_conn_rate(https_ingress) ge 50 }

    # TLS SNI (Server Name Indication) based routing
    acl is_main_frontend req_ssl_sni -i fiscalismia.com
    acl is_main_backend req_ssl_sni -i backend.fiscalismia.com
    acl is_main_fastapi req_ssl_sni -i fastapi.fiscalismia.com
    acl is_demo_frontend req_ssl_sni -i demo.fiscalismia.com
    acl is_demo_backend req_ssl_sni -i backend.demo.fiscalismia.com
    acl is_demo_fastapi req_ssl_sni -i fastapi.demo.fiscalismia.com
    acl is_monitoring req_ssl_sni -i monitoring.fiscalismia.com

    # when no SNI based rules are matched, immediately drop traffic silently.
    # silent-drop slows down attackers by producing timeouts instead of serving immediate rejection messages.
    # dropping content still shows in the logs, see https://www.haproxy.com/documentation/haproxy-configuration-tutorials/security/traffic-policing/#reject-a-tcp-connection
    acl valid_sni req_ssl_sni -i demo.fiscalismia.com backend.demo.fiscalismia.com fastapi.demo.fiscalismia.com monitoring.fiscalismia.com fiscalismia.com backend.fiscalismia.com fastapi.fiscalismia.com
    tcp-request content silent-drop if !valid_sni

    # Emit do-log after SNI validation and rate-limit filtering.
    # Triggers the "on tcp-req-cont" format in the log-profile,
    tcp-request content do-log

    use_backend react if is_main_frontend
    use_backend rest_api if is_main_backend
    use_backend webscraper if is_main_fastapi
    use_backend demo_react if is_demo_frontend
    use_backend demo_rest_api if is_demo_backend
    use_backend demo_webscraper if is_demo_fastapi
    use_backend prometheus_grafana if is_monitoring

#######################################################################
# Backend - HTTPS with Proxy Protocol V2
#######################################################################
backend react
    balance roundrobin
    server frontend01 172.24.0.3:443 send-proxy-v2 check-send-proxy

backend rest_api
    balance roundrobin
    server backend01 172.24.0.4:443 send-proxy-v2 check-send-proxy

backend webscraper
    balance roundrobin
    server fastapi01 172.24.0.4:8444 send-proxy-v2 check-send-proxy

backend demo_react
    balance roundrobin
    server demo_frontend01 172.20.0.2:443 send-proxy-v2 check-send-proxy

backend demo_rest_api
    balance roundrobin
    server demo_backend01 172.20.0.2:8443 send-proxy-v2 check-send-proxy

backend demo_webscraper
    balance roundrobin
    server demo_fastapi01 172.20.0.2:8444 send-proxy-v2 check-send-proxy

backend prometheus_grafana
    balance roundrobin
    server monitoring01 172.24.0.2:443 send-proxy-v2 check-send-proxy

#################################################################
# STATS PAGE (Optional - for monitoring)
#################################################################
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats auth "${STATS_USERNAME}":"${STATS_PASSWORD}"
