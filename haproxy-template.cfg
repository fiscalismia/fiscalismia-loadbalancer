#####################################################################################
# Fiscalismia-Loadbalancer HAProxy as central HTTPS Ingress for hcloud infrastructure
#
# Host-Based-Routing in Private Network:
#   - monitoring.fiscalismia.com         -> Monitoring   (172.24.0.2)
#   - fiscalismia.com                    -> Frontend     (172.24.0.3)
#   - backend.fiscalismia.com            -> Backend      (172.24.0.4)
#   - demo.fiscalismia.com               -> Demo Front   (172.20.0.2)
#   - backend.demo.fiscalismia.com       -> Demo Backend (172.20.0.2)
#####################################################################################

global
    # Logging: Send logs to stdout in raw format at info level
    # This is container-friendly and allows Docker to handle log collection
    log stdout format raw local0 info

    # Maximum concurrent connections the load balancer will accept
    # Prevents resource exhaustion attacks by limiting total connections
    maxconn 4096

    # Run as daemon: Forks into background after startup (production mode)
    # Disable this for debugging or when running in Docker foreground
    daemon

    # Security: Restrict file system operations after startup
    # Prevents directory traversal attacks and limits file access
    chroot /var/lib/haproxy

    # Security: Run as non-privileged user after binding to ports
    # Reduces impact if HAProxy is compromised
    user haproxy
    group haproxy

    # Diffie-Hellman parameter size for key exchange (2048 bits minimum)
    # Ensures strong encryption for TLS connections
    tune.ssl.default-dh-param 2048

    # Cipher suites: Only allow modern, secure ciphers for TLS
    # ECDHE provides forward secrecy, GCM provides authenticated encryption
    # Order matters: HAProxy prefers ciphers in the order listed
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384

    # TLS cipher suites for TLSv1.3 (newer protocol version)
    # TLS 1.3 has a smaller, more secure cipher suite selection
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256

    # TLS version restrictions and security options
    # ssl-min-ver TLSv1.2: Reject SSLv3, TLS 1.0, TLS 1.1 (all have known vulnerabilities)
    # no-tls-tickets: Disable session tickets to prevent certain attacks
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets

    # Spread health checks randomly within their intervals
    # Prevents thundering herd problem when many checks fire simultaneously
    max-spread-checks 5000

    # Number of threads to use for processing (adjust based on CPU cores)
    # More threads = better performance on multi-core systems
    # nbthread 4

    # CPU affinity: Bind threads to specific CPU cores for better cache locality
    # Uncomment and adjust if you need precise CPU control
    # cpu-map auto:1/1-4 0-3

defaults
    # Inherit logging configuration from global section
    log     global

    # Mode: HTTP layer 7 processing with full request/response analysis
    # Enables content inspection, header manipulation, and routing decisions
    mode    http

    # Log format: Use HTTP-specific logging with detailed request information
    # Captures timing, status codes, bytes transferred, and more
    option  httplog

    # Don't log connections with no data transfer (connection probes, scans)
    # Reduces log noise from monitoring systems and port scanners
    option  dontlognull

    # Connection handling: Close server connections after each response
    # Keeps client connections alive (HTTP keep-alive) but not server connections
    # Balances connection reuse benefits with backend connection limits
    option  http-server-close

    # Add X-Forwarded-For header with client's IP address
    # Except for localhost/RFC1918 to avoid header injection attacks
    # Backends can see the real client IP instead of HAProxy's IP
    option  forwardfor except 127.0.0.0/8

    # Retry failed requests on another server after connection failure
    # Improves fault tolerance when backend servers fail mid-request
    option  redispatch

    # Number of connection retry attempts before giving up
    # Helps handle transient network issues or server restarts
    retries 3

    # Maximum time to wait for backend connection to establish
    # Should be low (1-5s) to quickly detect dead servers
    timeout connect 5s

    # Maximum inactivity time on client side before closing connection
    # Protects against slowloris attacks and hung client connections
    timeout client  50s

    # Maximum inactivity time on server side before closing connection
    # Should match typical backend application response times
    timeout server  50s

    # Maximum time to receive complete HTTP request headers from client
    # Prevents slow header attacks (slowloris variant)
    # Lower values (5-10s) provide better protection
    timeout http-request 10s

    # Maximum time to wait for new HTTP request on keep-alive connection
    # After this, the connection is closed to free resources
    timeout http-keep-alive 10s

    # Maximum time for the client to send full request body
    # Important for file uploads and POST requests
    timeout client-fin 30s

    # Maximum time for the server to send full response
    # Important for large file downloads
    timeout server-fin 30s

    # Security: Enable HTTP strict transport security header insertion
    # Forces browsers to use HTTPS for future requests (when HTTPS is enabled)
    # Uncomment when HTTPS is active
    # http-response set-header Strict-Transport-Security "max-age=31536000; includeSubDomains"

    # Security: Prevent clickjacking attacks
    # http-response set-header X-Frame-Options "SAMEORIGIN"

    # Security: Enable XSS protection in browsers
    # http-response set-header X-Content-Type-Options "nosniff"

    # Security: Remove HAProxy version from error pages
    # Prevents information disclosure about infrastructure
    # option http-server-close already handles this

#######################################################################
# FRONTEND - HTTP (Port 80) -  TODO: Remove after development concludes
#######################################################################
frontend http_frontend
    # Bind to all interfaces on port 80 (HTTP)
    # Use specific IP (e.g., bind 0.0.0.0:80) for multi-IP systems
    bind *:80

    # Operating mode: HTTP with full request/response parsing
    mode http

    # Rate limiting: Maximum new connections per second to prevent abuse
    # Adjust based on expected legitimate traffic patterns
    rate-limit sessions 100

    # ACLs (Access Control Lists): Pattern matching for routing decisions
    # hdr(host) matches the HTTP Host header sent by the client
    # -i flag makes matching case-insensitive
    acl host_frontend hdr(host) -i fiscalismia.com
    acl host_backend hdr(host) -i backend.fiscalismia.com
    acl host_demo hdr(host) -i demo.fiscalismia.com
    acl host_backend_demo hdr(host) -i backend.demo.fiscalismia.com
    acl host_monitoring hdr(host) -i monitoring.fiscalismia.com

    # Security: Block requests without Host header (HTTP/1.1 requirement)
    # Prevents host header injection and malformed requests
    http-request deny deny_status 400 if !{ req.hdr(host) -m found }

    # Security: Reject requests with multiple Host headers
    # Prevents HTTP request smuggling attacks
    http-request deny deny_status 400 if { req.hdr_cnt(host) gt 1 }

    # Security: Block common attack patterns in URI
    # Prevents directory traversal, null byte injection
    acl is_malicious_uri path_reg -i \.\.|\\x00|\\r|\\n
    http-request deny deny_status 403 if is_malicious_uri

    # Security: Block requests with suspicious characters in headers
    # Prevents header injection attacks
    http-request deny deny_status 400 if { req.hdr_names -m reg -i [^a-zA-Z0-9-] }

    # Routing decisions: Use specific backend based on Host header match
    # Order matters: First match wins
    use_backend frontend if host_frontend
    use_backend backend if host_backend
    use_backend demo if host_demo
    use_backend demo if host_backend_demo
    use_backend monitoring if host_monitoring

    # Default backend: Return 404 for unknown hosts
    # Prevents routing to wrong backend or exposing internal services
    default_backend default

#################################################################
# FRONTEND - HTTPS (Port 443) - TLS Passthrough
# Backend servers must handle SSL/TLS termination themselves
#################################################################
#
# frontend https_frontend
#     # Bind to all interfaces on port 443 (HTTPS)
#     bind *:443
#
#     # Mode TCP: No decryption, just forward encrypted packets
#     # Required for TLS passthrough - HAProxy doesn't see plaintext
#     mode tcp
#
#     # Rate limiting: Maximum new connections per second to prevent abuse
#     # Adjust based on expected legitimate traffic patterns
#     rate-limit sessions 100
#
#     # Logging: Use TCP-specific log format (not HTTP)
#     option tcplog
#
#     # SNI (Server Name Indication): Extract hostname from TLS handshake
#     # Inspect TLS ClientHello message to determine routing destination
#     tcp-request inspect-delay 5s
#     tcp-request content accept if { req_ssl_hello_type 1 }
#
#     # ACLs for SNI-based routing: Match TLS SNI field
#     # req_ssl_sni extracts server name from TLS handshake
#     acl host_frontend req_ssl_sni -i fiscalismia.com
#     acl host_backend req_ssl_sni -i backend.fiscalismia.com
#     acl host_demo req_ssl_sni -i demo.fiscalismia.com
#     acl host_backend_demo req_ssl_sni -i backend.demo.fiscalismia.com
#     acl host_monitoring req_ssl_sni -i monitoring.fiscalismia.com
#
#     # Routing: Forward to SSL-enabled backends based on SNI
#     use_backend frontend_ssl if host_frontend
#     use_backend backend_ssl if host_backend
#     use_backend demo_ssl if host_demo
#     use_backend demo_ssl if host_backend_demo
#     use_backend monitoring_ssl if host_monitoring

####################################################################
# BACKENDS - HTTP (Port 80) TODO: Remove after development concludes
####################################################################

backend frontend
    # Mode: HTTP with full request/response processing
    mode http

    # Load balancing algorithm: Round-robin distributes requests evenly
    # Alternative: leastconn (least connections), source (IP hash)
    balance roundrobin

    # Health check: HTTP GET request to  /hc endpoint
    # Ensures backend is responding to HTTP requests, not just accepting TCP
    option httpchk GET  /hc

    # Expected health check response: HTTP 200 OK
    # Backend must return this status or it's marked as down
    http-check expect status 200

    # Security: Add security headers to responses
    # X-Frame-Options prevents clickjacking
    http-response set-header X-Frame-Options "SAMEORIGIN"

    # Security: Prevent MIME type sniffing
    http-response set-header X-Content-Type-Options "nosniff"

    # Security: Remove server version information
    # Prevents information disclosure about backend technology
    http-response del-header Server

    # Backend server definition:
    # - frontend01: Server identifier for logs/stats
    # - 172.24.0.3:80: Private IP and port
    # - check: Enable health checks
    # - inter 10s: Check interval (every 10 seconds)
    # - fall 3: Mark down after 3 failed checks
    # - rise 2: Mark up after 2 successful checks
    server frontend01 172.24.0.3:80 check inter 10s fall 3 rise 2

backend backend
    mode http
    balance roundrobin
    option httpchk GET  /hc
    http-check expect status 200
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response del-header Server
    server backend01 172.24.0.4:80 check inter 10s fall 3 rise 2

backend demo
    mode http
    balance roundrobin
    option httpchk GET  /hc
    http-check expect status 200
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response del-header Server
    server demo01 172.20.0.2:80 check inter 10s fall 3 rise 2

backend monitoring
    mode http
    balance roundrobin
    option httpchk GET  /hc
    http-check expect status 200
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    http-response del-header Server
    server monitoring01 172.24.0.2:80 check inter 10s fall 3 rise 2

backend default
    # Default backend for unknown/invalid hosts
    mode http

    # Deny all requests with 404 Not Found
    # Security: Don't expose that a load balancer exists
    http-request deny deny_status 404

#################################################################
# BACKENDS - HTTPS (Port 443) - TLS Passthrough (Future Use)
#################################################################
# Uncomment when ready for HTTPS with TLS passthrough
# TLS passthrough backends forward encrypted traffic without decryption
#
# backend frontend_ssl
#     # Mode TCP: Forward encrypted packets without inspection
#     mode tcp
#
#     # Load balancing: Round-robin across SSL-enabled servers
#     balance roundrobin
#
#     # Health check: SSL hello check
#     # Verifies server accepts SSL/TLS connections
#     # Doesn't decrypt or validate certificates
#     option ssl-hello-chk
#
#     # Backend server with SSL enabled
#     # - check: Enable health checks
#     # - inter 10s: Check every 10 seconds
#     # - fall 3: Mark down after 3 failures
#     # - rise 2: Mark up after 2 successes
#     server frontend01 172.24.0.3:443 check inter 10s fall 3 rise 2
#
# backend backend_ssl
#     mode tcp
#     balance roundrobin
#     option ssl-hello-chk
#     server backend01 172.24.0.4:443 check inter 10s fall 3 rise 2
#
# backend demo_ssl
#     mode tcp
#     balance roundrobin
#     option ssl-hello-chk
#     server demo01 172.20.0.2:443 check inter 10s fall 3 rise 2
#
# backend monitoring_ssl
#     mode tcp
#     balance roundrobin
#     option ssl-hello-chk
#     server monitoring01 172.24.0.2:443 check inter 10s fall 3 rise 2

#################################################################
# STATS PAGE (Optional - for monitoring)
#################################################################
listen stats
    # Bind to all interfaces on port 8404 for stats page
    # Consider binding to localhost only for security: bind 127.0.0.1:8404
    bind *:8404

    # Mode: HTTP required for stats page interface
    mode http

    # Enable statistics reporting interface
    stats enable

    # URI path for stats page (access via http://server:8404/stats)
    # Consider using a non-obvious path for security
    stats uri /stats

    # Auto-refresh interval: Update stats page every 30 seconds
    # Useful for real-time monitoring without manual refresh
    stats refresh 30s

    # Show legends: Display explanations for all metrics
    # Helps understanding what each number represents
    stats show-legends

    # Show node name: Display server hostname in stats
    # Useful in multi-server setups to identify which HAProxy instance
    stats show-node

    # SECURITY WARNING: Change these default credentials!
    # Basic HTTP authentication for stats page access
    # Password is transmitted in base64 (NOT encrypted) - use HTTPS in production
    # Use strong passwords and consider multiple user accounts with different permissions
    stats auth admin:changeme123

    # Additional security: Restrict access by source IP
    # Uncomment and adjust to limit stats access to specific networks
    # acl allowed_networks src 10.0.0.0/8 172.16.0.0/12 192.168.0.0/16
    # http-request deny unless allowed_networks

    # Hide HAProxy version in stats page (information disclosure prevention)
    stats hide-version

    # Admin level: Allow server state changes via stats page
    # WARNING: This is powerful! Only enable if you need web-based server management
    # Requires authentication (stats auth)
    # stats admin if TRUE
