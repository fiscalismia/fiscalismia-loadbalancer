echo -e "PROXY TCP4 127.0.0.1 127.0.0.1 12345 443\r\n" | nc -v4 172.20.0.2 443

    option tcp-check
    tcp-check send-proxy-v2
my demo instance is running an nginx reverse proxy on port 443 as a container listening
it uses proxy protocol to preserve source ip and read it

demo debugging:
[root@Fiscalismia-Demo ~]# hostname -I
172.20.0.2
[root@Fiscalismia-Demo ~]# netstat -ltnp | grep 443
tcp        0      0 0.0.0.0:443             0.0.0.0:*               LISTEN      6215/conmon
[root@Fiscalismia-Demo ~]# nc -vz4 localhost 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connected to 127.0.0.1:443.
Ncat: 0 bytes sent, 0 bytes received in 0.03 seconds.

loadbalancer debugging:
# when nginx is up:
[root@Fiscalismia-LoadBalancer ~]# nc -v4 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: TIMEOUT.
# when no nginx docker container is running:
nc -v4 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connection refused.
# when demo server had "python3 -m http.server 443" running
curl 172.20.0.2:443
<!DOCTYPE HTML>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Directory listing for /</title>
</head>
<body>
<h1>Directory listing for /</h1>
<hr>
<ul>
</ul>
<hr>
</body>
</html>
nc -vz4 172.20.0.2 443
Ncat: Version 7.92 ( https://nmap.org/ncat )
Ncat: Connected to 172.20.0.2:443.
Ncat: 0 bytes sent, 0 bytes received in 0.03 seconds.



However my haproxy loadbalancer is still giving layer 4 timeouts and the health checks are not reaching the listeners and i do not understand why.

```
[NOTICE]   (1) : Initializing new worker (3)
[NOTICE]   (3) : haproxy version is 3.2.8-9200f39
[WARNING]  (3) : [haproxy.main()] Failed to drop supplementary groups. Using 'gid'/'group' without 'uid'/'user' is generally useless.
[NOTICE]   (1) : Loading success.
Server fiscalismia_frontend/frontend01 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 2ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
backend fiscalismia_frontend has no server available!
[WARNING]  (3) : Server fiscalismia_frontend/frontend01 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 2ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
[ALERT]    (3) : backend 'fiscalismia_frontend' has no server available!
Server fiscalismia_monitoring/monitoring01 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 2ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
backend fiscalismia_monitoring has no server available!
[WARNING]  (3) : Server fiscalismia_monitoring/monitoring01 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 2ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
[ALERT]    (3) : backend 'fiscalismia_monitoring' has no server available!
Server fiscalismia_backend/backend01 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 2ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
backend fiscalismia_backend has no server available!
[WARNING]  (3) : Server fiscalismia_backend/backend01 is DOWN, reason: Layer4 connection problem, info: "Connection refused", check duration: 2ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
[ALERT]    (3) : backend 'fiscalismia_backend' has no server available!
Server fiscalismia_demo_frontend/demo_frontend01 is DOWN, reason: Layer4 timeout, check duration: 10004ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
backend fiscalismia_demo_frontend has no server available!
[WARNING]  (3) : Server fiscalismia_demo_frontend/demo_frontend01 is DOWN, reason: Layer4 timeout, check duration: 10004ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
[ALERT]    (3) : backend 'fiscalismia_demo_frontend' has no server available!
Server fiscalismia_demo_backend/demo_backend01 is DOWN, reason: Layer4 timeout, check duration: 10005ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
backend fiscalismia_demo_backend has no server available!
[WARNING]  (3) : Server fiscalismia_demo_backend/demo_backend01 is DOWN, reason: Layer4 timeout, check duration: 10005ms. 0 active and 0 backup servers left. 0 sessions active, 0 requeued, 0 remaining in queue.
[ALERT]    (3) : backend 'fiscalismia_demo_backend' has no server available!

```

this is my nginx.conf

```
server {
    # Enable PROXY protocol on the listen directive
    listen 443 ssl proxy_protocol;

    server_name demo.fiscalismia.com;

    # Your TLS certificates
    ssl_certificate     /etc/nginx/certs/fullchain.pem;
    ssl_certificate_key /etc/nginx/certs/privkey.pem;
    ssl_protocols       TLSv1.3;

    # Trust HAProxy's PROXY protocol data
    # Set to your HAProxy IP(s)
    set_real_ip_from 172.24.1.3;  # HAProxy internal IP production network
    set_real_ip_from 172.20.1.3;  # HAProxy internal IP demo network

    # Use PROXY protocol to get real IP
    real_ip_header proxy_protocol;

    # Now $remote_addr contains the real client IP
    # You can pass it to your application
    location / {
        # proxy_pass http://your_app:8080;
        return 200 'Hello from Nginx, real client IP is $remote_addr!';
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_protocol_addr;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # For logging the real client IP
    access_log /var/log/nginx/access.log combined;
}
```

haproxy config:


```
###########################################################################################
# Fiscalismia-Loadbalancer HAProxy as central Layer 4 TCP Ingress for hcloud infrastructure
#
# Host-Based-Routing in Private Network:
#   - monitoring.fiscalismia.com         -> Monitoring    (172.24.0.2)
#   - fiscalismia.com                    -> Frontend      (172.24.0.3)
#   - backend.fiscalismia.com            -> Backend       (172.24.0.4)
#   - demo.fiscalismia.com               -> Demo Frontend (172.20.0.2)
#   - backend.demo.fiscalismia.com       -> Demo Backend  (172.20.0.2)

# Uses Server Name Indication as part of the TLS protocol for identifying dns routes
# Uses PROXY Protocol v2 prepending headers to TCP packets for source address preservation
# ┌──────────────────────────────────────────────────────────────────────────────┐
# │                         TCP Connection                                       │
# ├───────────────────────┬──────────────────────────────────────────────────────┤
# │   PROXY Protocol v2   │              Original TLS Stream                     │
# │       Header          │                                                      │
# │    (first bytes)      │  TLS ClientHello │ TLS ServerHello │ Encrypted HTTP  │
# └───────────────────────┴──────────────────────────────────────────────────────┘
#          │                                          │
#          ▼                                          ▼
# ┌─────────────────────────────┐          ┌─────────────────────────┐
# │ Binary header containing:   │          │ Untouched TLS stream    │
# │ - Signature (12 bytes)      │          │ passed to TLS library   │
# │ - Version/Command           │          │ for decryption          │
# │ - Protocol (TCP4/TCP6)      │          └─────────────────────────┘
# │ - Address length            │
# │ - Source IP: 203.0.113.42   │  ◄── Client IP preservation
# │ - Dest IP: 1.2.3.4          │
# │ - Source Port: 54321        │
# │ - Dest Port: 443            │
# └─────────────────────────────┘
###########################################################################################

# Process-wide security and performance tunings affecting HAProxy at a low-level
global
    # Maximum simultaneous connections to limit memory consumption
    maxconn 4096

    # Logging: Send logs to stdout in raw format at info level, exposing docker container logs in live tail
    log stdout format raw local0 debug

    # Run as daemon: Forks into background after startup (production mode)
    # Disable this for debugging or when running in Docker foreground
    # TODO enable in prod
    # daemon

    # Non-root service user as security best-practice
    user haproxy
    group haproxy

defaults

    # Inherit logging configuration from global section
    log     global
    # Layer 4 TLS Passthrough of binary TCP packets
    mode    tcp
    # Defines the log format, the default being:
    # option tcplog
    log-format "%ci:%cp [%t] %ft %b/%s %Tw/%Tc/%Tt %B %ts %ac/%fc/%bc/%sc/%rc %sq/%bq"

    ##### CONNECTION SETTINGS #####
    # Number of connection retry attempts before giving up
    retries 3
    # Time to wait for connections to the backend servers to establish
    timeout connect 10s
    # Inactivity time on client side before closing connection
    timeout client  30s
    # Inactivity time on server side before closing connection
    timeout server  30s
    # TCP specific long-lived sessions for e.g. ETL data processing
    timeout tunnel 5m

    ##### DEFAULT BACKEND SERVER CONFIG #####
    # - check: Enable health checks
    # - inter: Check interval (every 10 seconds)
    # - fall:  Mark server as down after 3 failed checks
    # - rise:  Mark server as up after 2 successful checks
    default-server check inter 10s fall 3 rise 2

#######################################################################
# FRONTEND - HTTP (Port 80) Redirect to HTTPS (443)
#######################################################################
frontend http_ingress
    bind *:80
    mode http

    # Allowed new connections per second
    rate-limit sessions 128

    # Redirect all HTTP to HTTPS
    http-request redirect scheme https code 301

#######################################################################
# FRONTEND - HTTPS (Port 443) TLS Passthrough with SNI Routing
#######################################################################
frontend https_ingress
    bind *:443
    mode tcp

    # Wait for TLS ClientHello to read SNI
    tcp-request inspect-delay 5s

    ##### RATE LIMITING #####
    # Tracks connections per ip address in a sliding window
    # If concurrent connections over the conn_rate window are exceeded,
    # then we silently drop the tcp connection leading to timeouts for the attacker.
    stick-table type ip size 500k expire 60s store conn_rate(3s)
    tcp-request connection track-sc0 src
    tcp-request content silent-drop if { src_conn_rate(https_ingress) ge 50 }

    # TLS SNI (Server Name Indication) based routing
    acl is_demo_frontend req_ssl_sni -i demo.fiscalismia.com
    acl is_demo_backend req_ssl_sni -i backend.demo.fiscalismia.com
    acl is_monitoring req_ssl_sni -i monitoring.fiscalismia.com
    acl is_main_frontend req_ssl_sni -i fiscalismia.com
    acl is_main_backend req_ssl_sni -i backend.fiscalismia.com

    # when no SNI based rules are matched, immediately drop traffic silently.
    # silent-drop slows down attackers by producing timeouts instead of serving immediate rejection messages.
    # dropping content still shows in the logs, see https://www.haproxy.com/documentation/haproxy-configuration-tutorials/security/traffic-policing/#reject-a-tcp-connection
    acl valid_sni req_ssl_sni -i demo.fiscalismia.com backend.demo.fiscalismia.com monitoring.fiscalismia.com fiscalismia.com backend.fiscalismia.com
    tcp-request content silent-drop if !valid_sni

    use_backend fiscalismia_demo_frontend if is_demo_frontend
    use_backend fiscalismia_demo_backend if is_demo_backend
    use_backend fiscalismia_monitoring if is_monitoring
    use_backend fiscalismia_frontend if is_main_frontend
    use_backend fiscalismia_backend if is_main_backend

#######################################################################
# Backend - HTTPS with Proxy Protocol V2
#######################################################################
backend fiscalismia_frontend
    balance roundrobin
    server frontend01 172.24.0.3:443 send-proxy-v2 check

backend fiscalismia_demo_frontend
    balance roundrobin
    server demo_frontend01 172.20.0.2:443 send-proxy-v2 check

backend fiscalismia_demo_backend
    balance roundrobin
    server demo_backend01 172.20.0.2:8443 send-proxy-v2 check

backend fiscalismia_monitoring
    balance roundrobin
    server monitoring01 172.24.0.2:443 send-proxy-v2 check

backend fiscalismia_backend
    balance roundrobin
    server backend01 172.24.0.4:443 send-proxy-v2 check

#################################################################
# STATS PAGE (Optional - for monitoring)
#################################################################
listen stats
    bind *:8404
    mode http
    stats enable
    stats uri /stats
    stats refresh 10s
    stats show-legends
    stats auth "${STATS_USERNAME}":"${STATS_PASSWORD}"


```

haproxy deployment:

```

scp .env Dockerfile haproxy.cfg ./errorfiles/503.http root@loadbalancer:/usr/local/etc/haproxy/

ssh loadbalancer << EOF
  cd /usr/local/etc/haproxy/

  podman build --no-cache \
    -f Dockerfile \
    -t fiscalismia-loadbalancer:latest .

  podman stop haproxy > /dev/null 2>&1
  podman container rm haproxy > /dev/null 2>&1

  # sudo sysctl net.ipv4.ip_unprivileged_port_start=80

  podman run \
    --name haproxy \
    --rm \
    --detach \
    --cap-add=NET_BIND_SERVICE \
    --network host \
    --env-file .env \
    -v "/usr/local/etc/haproxy/haproxy.cfg:/usr/local/etc/haproxy.cfg:ro,z" \
    fiscalismia-loadbalancer:latest

    podman logs --follow haproxy
EOF

```

haproxy Dockerfile
```
#####################################################################################
# Fiscalismia-Loadbalancer HAProxy as central HTTPS Ingress for hcloud infrastructure
#####################################################################################

FROM docker.io/library/haproxy:3.2.8-alpine

# 1. Switch to root to have permission to create directories
USER root

# 2. Create the directory and ensure haproxy user owns it
RUN mkdir -p /usr/local/etc/haproxy/errorfiles/
RUN chown -R haproxy:haproxy /usr/local/etc/haproxy/

WORKDIR /usr/local/etc/haproxy/

COPY haproxy.cfg /usr/local/etc/haproxy.cfg
COPY 503.http /usr/local/etc/haproxy/errorfiles/503.http

# Validate configuration at build time
RUN haproxy -c -f /usr/local/etc/haproxy.cfg

# Expose ports - this is a purely cosmetic setting. It is applied in docker compose.
# 80  - HTTP - TODO Remove after Development concludes
# 443 - HTTPS (TLS Passthrough)
# 8404 - Stats page - TODO Remove after Development concludes
EXPOSE 80 443 8404

# Run as non-root user after binding to ports (haproxy user already exists in official image)
USER haproxy

# Use exec form to ensure proper signal handling
CMD ["haproxy", "-f", "/usr/local/etc/haproxy.cfg"]
```

demo dockerfile:
```
FROM nginx:stable-alpine
RUN mkdir -p /etc/nginx/certs
COPY fullchain.pem /etc/nginx/certs/fullchain.pem
COPY privkey.pem /etc/nginx/certs/privkey.pem
COPY nginx.demo.conf /etc/nginx/conf.d/default.conf
EXPOSE 443
CMD ["nginx", "-g", "daemon off;"]
```

demo deployment:
```

REMOTE_DIR="/usr/local/etc/nginx"

ssh demo "mkdir -p $REMOTE_DIR"
scp Dockerfile.demo nginx.demo.conf demo:$REMOTE_DIR/
ssh demo << EOF
cd $REMOTE_DIR

cp /etc/letsencrypt/live/demo.fiscalismia.com/fullchain.pem $REMOTE_DIR/fullchain.pem
cp /etc/letsencrypt/live/demo.fiscalismia.com/privkey.pem $REMOTE_DIR/privkey.pem

podman build --no-cache \
  -f Dockerfile.demo \
  -t fiscalismia-demo:latest .

podman stop demo > /dev/null 2>&1
podman container rm demo > /dev/null 2>&1

podman run \
  --name demo \
  --detach \
  --rm \
  -p 443:443 \
  fiscalismia-demo:latest

podman logs --follow demo
EOF
```